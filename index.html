<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <title>SKINLABSÂ® â€” Curated Skincare for South Africa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Derm-informed guides, deals, reviews, and personalised routines for South Africans." />
  <link rel="canonical" href="https://skinlabs.co.za/" />

  <!-- OG/Twitter -->
  <meta property="og:title" content="SKINLABSÂ® â€” Curated Skincare for South Africa" />
  <meta property="og:description" content="Derm-informed guides, reviews, deals & personalised routines." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://skinlabs.co.za/" />
  <meta property="og:image" content="https://skinlabs.co.za/assets/og-skynn.jpg" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="theme-color" content="#0c0e10" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Material+Symbols+Outlined" rel="stylesheet" />

  <!-- AdSense (your client) -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1237323355260727" crossorigin="anonymous"></script>

  <!-- JSON-LD: Organization + WebSite (SearchAction) -->
  <script type="application/ld+json">
  {"@context":"https://schema.org","@type":"Organization","name":"SKINLABS","url":"https://skinlabs.co.za","logo":"https://skinlabs.co.za/assets/logo.png"}
  </script>
  <script type="application/ld+json">
  {"@context":"https://schema.org","@type":"WebSite","url":"https://skinlabs.co.za/","name":"SKINLABS","potentialAction":{"@type":"SearchAction","target":"https://skinlabs.co.za/?q={search_term_string}","query-input":"required name=search_term_string"}}
  </script>

  <style>
    :root{
      --bg:#0c0e10; --panel:#111418; --muted:#8ca5b3; --brand:#6ee7d2; --brand2:#b3e5ff; --text:#eef3f5;
      --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.35); --maxw:1080px; --gap:14px;
      --ad-desktop:728px; --ad-mobile:336px;
    }
    html[data-theme="light"]{
      --bg:#f6f7f9; --panel:#ffffff; --muted:#5c6b76; --brand:#0bb3a0; --brand2:#e6f4ff; --text:#182026;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    img{max-width:100%;height:auto;display:block}
    a{color:var(--brand);text-decoration:none}
    button{font:inherit;cursor:pointer}
    .wrap{max-width:var(--maxw);margin:0 auto;padding:0 14px}
    .sr-only{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px)}

    header{position:sticky;top:0;z-index:100;backdrop-filter:saturate(1.2) blur(8px);background:color-mix(in oklab, var(--bg) 90%, transparent);border-bottom:1px solid rgba(0,0,0,.08)}
    .nav{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 0}
    .brand{display:flex;gap:10px;align-items:center;font-weight:800;letter-spacing:.3px;font-size:18px;white-space:nowrap}
    .brand-icon{display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:8px;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#052a23}
    .badge{font-size:12px;color:var(--muted)}
    .drawer{display:none}
    .hamburger,.theme-btn{display:inline-flex;gap:6px;align-items:center;background:var(--panel);border:1px solid rgba(0,0,0,.12);border-radius:10px;color:inherit;padding:8px 10px}
    .theme-btn .material-symbols-outlined{font-size:18px}
    .drawer.open{position:fixed;inset:56px 10px auto 10px;z-index:120;display:flex;flex-direction:column;gap:6px;background:var(--panel);border:1px solid rgba(0,0,0,.1);border-radius:12px;padding:10px;max-width:calc(var(--maxw) - 20px);width:calc(100% - 20px)}
    .drawer a{display:flex;align-items:center;gap:8px;color:inherit;padding:10px;border-radius:10px}
    .drawer a:hover{background:color-mix(in oklab, var(--panel) 85%, #0000)}
    .icon{font-family:"Material Symbols Outlined";font-size:18px;line-height:1}
    @media (min-width: 900px){ .hamburger{display:none} .drawer{display:flex;position:static;flex-direction:row;gap:10px;background:transparent;border:none;padding:0} .drawer a{padding:8px 10px} }

    .panel{background:linear-gradient(180deg,color-mix(in oklab, var(--panel) 100%, #0000), color-mix(in oklab, var(--panel) 95%, #0000) 60%);border:1px solid rgba(0,0,0,.08);border-radius:var(--radius);box-shadow:var(--shadow);min-width:0}
    .section-title{display:flex;align-items:center;justify-content:space-between;margin:6px 0 8px}
    .section-title h2{font-size:clamp(15px,2.4vw,20px);margin:0}
    .small{font-size:12px}.muted{color:var(--muted)}
    .divider{height:1px;background:rgba(0,0,0,.12);margin:10px 0}

    .hero{display:grid;grid-template-columns:1fr;gap:var(--gap);padding:var(--gap) 0 8px}
    @media (min-width: 980px){ .hero{grid-template-columns:1.2fr .8fr} }
    .hero .panel{padding:14px}
    .hero h1{margin:.2rem 0 0;font-size:clamp(20px,5vw,34px);line-height:1.15}
    .hero p{color:var(--muted);font-size:clamp(14px,2.5vw,16px)}
    .searchbar{display:flex;gap:8px;margin-top:10px}
    .input{flex:1;padding:12px 14px;border-radius:10px;background:color-mix(in oklab, var(--bg) 92%, #0000);border:1px solid rgba(0,0,0,.12);color:inherit;min-width:0}
    .btn{padding:12px 14px;border-radius:10px;background:var(--brand);color:#07332b;border:none;font-weight:700}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .chip{padding:7px 10px;border-radius:999px;font-size:12px;color:#0b1415;background:var(--brand2);border:1px solid rgba(0,0,0,.12)}

    /* Sliders */
    .slider{position:relative;overflow:hidden;padding:4px 32px} /* padding for arrows */
    .slides{display:flex;transition:transform .35s ease;will-change:transform;touch-action:pan-y pinch-zoom}
    .slide{flex:0 0 auto;width:100%;padding:0 6px;box-sizing:border-box}
    .navbtn{position:absolute;top:50%;transform:translateY(-50%);z-index:5;border:none;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.18);backdrop-filter:blur(6px);color:#fff;width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center}
    .navbtn.prev{left:6px}.navbtn.next{right:6px}
    .slides[data-per="1"] .slide{width:100%} .slides[data-per="2"] .slide{width:50%} .slides[data-per="3"] .slide{width:33.3333%} .slides[data-per="4"] .slide{width:25%}

    .card{padding:12px;border-radius:16px;background:linear-gradient(180deg,color-mix(in oklab, var(--panel) 95%, #0000), color-mix(in oklab, var(--panel) 92%, #0000) 70%);border:1px solid rgba(0,0,0,.08)}
    .card h3{margin:8px 0 4px;font-size:clamp(14px,2.4vw,18px)}
    .meta{font-size:12px;color:var(--muted)}
    .tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .tag{font-size:11px;border:1px solid rgba(0,0,0,.1);padding:3px 7px;border-radius:999px;color:color-mix(in oklab, var(--text) 85%, #000)}
    .rating{color:#ffdf6c}
    .cta{display:inline-flex;gap:6px;align-items:center;padding:8px 10px;border-radius:10px;background:color-mix(in oklab, var(--bg) 92%, #0000);border:1px solid rgba(0,0,0,.12);color:inherit}

    .grid{margin:10px 0 22px;display:grid;grid-template-columns:1fr;gap:var(--gap);min-width:0}
    @media (min-width: 980px){ .grid{grid-template-columns:2fr 1fr} }
    .sticky{position:static} @media (min-width:980px){ .sticky{position:sticky;top:76px} }

    .review-list{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width: 700px){ .review-list{grid-template-columns:repeat(2,1fr)} }
    .review{background:color-mix(in oklab, var(--panel) 92%, #0000);border:1px solid rgba(0,0,0,.08);border-radius:12px;padding:12px}

    .adbox{display:flex;justify-content:center;margin:10px 0}
    .ad-inner{width:100%;max-width:var(--ad-desktop)} .adsbygoogle{display:block;width:100%}
    @media (max-width: 600px){ .ad-inner{max-width:var(--ad-mobile)} }

    /* Footer */
    footer{margin:26px 0 60px;color:var(--muted)}
    .socials{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
    .socials a{display:inline-flex;gap:6px;align-items:center;color:inherit}
    .store-badges{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .store-badges img{height:44px;width:auto;display:block}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;place-items:center;padding:14px;z-index:200}
    .modal .inner{background:var(--panel);border:1px solid rgba(0,0,0,.1);border-radius:16px;max-width:620px;width:calc(100% - 28px);padding:14px;color:inherit}

    #fabChat{position:fixed;right:16px;bottom:calc(16px + env(safe-area-inset-bottom));z-index:150;border:none;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#052a23;border-radius:50%;width:56px;height:56px;box-shadow:0 10px 25px rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center}
    #chatPanel{position:fixed;right:16px;bottom:86px;width:min(420px,calc(100% - 32px));z-index:160;display:none}
    #chatPanel .inner{background:var(--panel);border:1px solid rgba(0,0,0,.1);border-radius:16px;overflow:hidden}
    .chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(0,0,0,.08)}
    .chat-body{max-height:55vh;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px}
    .msg{padding:10px;border-radius:12px;max-width:88%}
    .me{align-self:flex-end;background:color-mix(in oklab, var(--brand) 25%, var(--panel));border:1px solid rgba(0,0,0,.08)}
    .ai{align-self:flex-start;background:color-mix(in oklab, var(--panel) 95%, #0000);border:1px solid rgba(0,0,0,.08)}
    .chat-foot{display:flex;gap:8px;padding:10px;border-top:1px solid rgba(0,0,0,.08)}
    .chat-foot .input{flex:1}

    .locked-note{padding:12px;border-radius:12px;background:color-mix(in oklab, var(--panel) 94%, #0000);border:1px dashed rgba(0,0,0,.2);text-align:center}
    .hidden{display:none !important}

    /* Onboarding visuals & progress */
    .ob-hero{display:flex;align-items:center;gap:10px;padding:6px 0}
    .ob-hero img{width:40px;height:40px;border-radius:12px}
    #obProgress{position:relative;height:6px;background:rgba(255,255,255,.08);border-radius:999px;overflow:hidden;margin:10px 0 4px}
    #obProgBar{position:absolute;inset:0 auto 0 0;width:0%;background:linear-gradient(90deg,var(--brand),var(--brand2));transition:width .25s ease;border-radius:inherit}
    #obStepsRow{display:flex;justify-content:space-between;font-size:11px;color:var(--muted)}
    #onboardSteps .step{animation:.15s ease obStepFade}
    @keyframes obStepFade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
    .step .chip{border-radius:999px;border:1px dashed rgba(255,255,255,.18);background:transparent;padding:6px 10px}
    .step .chip input{margin-right:6px}

    /* Featured & Stories smaller */
    .story-card{max-width:230px;margin:0 auto}

    /* Forum visuals */
    .forum .review{position:relative}
    .star{font-family:"Material Symbols Outlined";font-size:16px;vertical-align:-2px}
    .verified{font-family:"Material Symbols Outlined";font-size:16px;color:#6ee7d2}
    .helpful{display:inline-flex;gap:6px;align-items:center;border:1px solid rgba(255,255,255,.1);padding:4px 8px;border-radius:999px;background:color-mix(in oklab, var(--panel) 96%, #0000)}
    .post-meta{font-size:12px;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap}
    .poll{border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;background:color-mix(in oklab, var(--panel) 94%, #0000)}
    .poll .bar{height:8px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden}
    .poll .bar > span{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--brand),var(--brand2));transition:width .25s ease}

    /* Remove pagination dots globally */
    .dots{display:none !important}
  </style>
</head>
<body>
<header>
  <div class="wrap nav">
    <div class="brand">
      <span class="brand-icon">ðŸ‡¿ðŸ‡¦</span>
      <span>SKINLABSÂ®</span>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="themeToggle" class="theme-btn" aria-label="Toggle theme"><span class="material-symbols-outlined">dark_mode</span></button>
      <button class="hamburger" id="navToggle" aria-label="Open menu"><span class="material-symbols-outlined">menu</span> Menu</button>
    </div>
    <nav class="drawer" id="drawer" aria-label="Primary">
      <a href="#explore"><span class="material-symbols-outlined">explore</span> Explore</a>
      <a href="#offers"><span class="material-symbols-outlined">local_mall</span> Deals</a>
      <a href="#reviews"><span class="material-symbols-outlined">forum</span> Reviews</a>
      <a href="#trending"><span class="material-symbols-outlined">trending_up</span> Trending</a>
      <a href="#signup" class="cta js-signup"><span class="material-symbols-outlined">person_add</span> Sign up</a>
      <a href="#login" class="cta js-signin"><span class="material-symbols-outlined">login</span> Login</a>
    </nav>
  </div>
</header>

<main class="wrap">

  <!-- Above-the-fold ad -->
  <div class="panel adbox" style="padding:6px;margin-top:10px">
    <div class="ad-inner">
      <ins class="adsbygoogle"
           style="display:block"
           data-ad-format="fluid"
           data-ad-layout-key="+1v+s2-4-5g+9z"
           data-ad-client="ca-pub-1237323355260727"
           data-ad-slot="3319371201" data-full-width-responsive="true"></ins>
      <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
    </div>
  </div>

  <section class="hero" id="hero">
    <div class="panel" style="padding:14px">
      <div class="badge">Launches <b>15 Aug 2025</b></div>
      <h1>The expertly curated, trusted guide to healthy skin</h1>
      <p>Derm-informed guides, ingredient explainers, local brand roundups and smarter deals. <span class="js-locked-copy">Join to unlock all features, AI chat, and member-only content.</span></p>

      <div class="searchbar" role="search" aria-label="Site search">
        <input id="q" class="input" placeholder="Search guides, ingredients, brandsâ€¦" aria-label="Search" />
        <button id="btnSearch" class="btn"><span class="material-symbols-outlined">search</span></button>
      </div>

      <div class="chips" id="chips" aria-label="Filters"></div>
      <div id="gateNote" class="locked-note js-locked-copy" style="margin-top:10px">
        ðŸ”’ Sign up (R99/year) to save favourites, write reviews and get full access.
        <div style="margin-top:8px"><button class="btn js-signup">Unlock access</button></div>
      </div>
    </div>

    <!-- Sponsored Offers slider -->
    <div class="panel" id="offersPanel" aria-label="Sponsored Offers" style="padding:14px">
      <div class="section-title">
        <h2>Sponsored Offers</h2>
        <a class="small muted" href="#offers">See all</a>
      </div>
      <div class="slider" id="offersSlider">
        <button class="navbtn prev" aria-label="Previous"><span class="material-symbols-outlined">chevron_left</span></button>
        <div class="slides" id="offersSlides" data-per="1"></div>
        <button class="navbtn next" aria-label="Next"><span class="material-symbols-outlined">chevron_right</span></button>
      </div>
    </div>
  </section>

  <!-- Explore -->
  <section id="explore" aria-label="Explore content">
    <div class="section-title">
      <h2>Latest Curations</h2>
      <div class="small muted">Filter: <span id="activeFilter">All</span></div>
    </div>

    <div class="slider" id="cardsSlider">
      <button class="navbtn prev" aria-label="Previous"><span class="material-symbols-outlined">chevron_left</span></button>
      <div id="cardsSlides" class="slides" data-per="1"></div>
      <button class="navbtn next" aria-label="Next"><span class="material-symbols-outlined">chevron_right</span></button>
    </div>
  </section>

  <!-- Featured Collections -->
  <section id="featuredCats" class="panel" style="padding:14px;margin-top:12px">
    <div class="section-title"><h2>Featured Collections</h2></div>
    <div class="slider" id="catsSlider">
      <button class="navbtn prev" aria-label="Previous"><span class="material-symbols-outlined">chevron_left</span></button>
      <div id="catsSlides" class="slides" data-per="1"></div>
      <button class="navbtn next" aria-label="Next"><span class="material-symbols-outlined">chevron_right</span></button>
    </div>
  </section>

  <!-- Trending -->
  <section id="trending" class="panel" style="padding:14px; margin-top:12px">
    <div class="section-title"><h2>Trending this week</h2></div>
    <div class="slider" id="topSlider">
      <button class="navbtn prev" aria-label="Previous"><span class="material-symbols-outlined">chevron_left</span></button>
      <div id="topSlides" class="slides" data-per="1"></div>
      <button class="navbtn next" aria-label="Next"><span class="material-symbols-outlined">chevron_right</span></button>
    </div>
  </section>

  <!-- Featured Articles (Medium) -->
  <section id="featured" class="panel" style="padding:14px;margin-top:12px">
    <div class="section-title"><h2>Featured on our Medium</h2><a class="small" href="https://blog.skinlabs.africa" target="_blank" rel="noopener">Visit blog</a></div>
    <div class="slider" id="featSlider">
      <button class="navbtn prev" aria-label="Previous"><span class="material-symbols-outlined">chevron_left</span></button>
      <div id="featSlides" class="slides" data-per="1"></div>
      <button class="navbtn next" aria-label="Next"><span class="material-symbols-outlined">chevron_right</span></button>
    </div>
  </section>

  <!-- Community Forum -->
  <section id="reviews" class="panel" style="padding:14px">
    <div class="section-title">
      <h2>Community Forum</h2>
      <button id="btnAddReview" class="cta js-signin"><span class="material-symbols-outlined">rate_review</span> Write a review</button>
    </div>
    <div class="review-list" id="reviewList"></div>
  </section>

  <!-- Web Stories (bottom) -->
  <section id="storyReels" class="panel" style="padding:14px;margin-top:12px">
    <div class="section-title">
      <h2>Web Stories</h2>
      <div class="small muted">Tap to view short skincare stories</div>
    </div>
    <div class="slider" id="storiesSlider">
      <button class="navbtn prev" aria-label="Previous"><span class="material-symbols-outlined">chevron_left</span></button>
      <div class="slides" id="storiesSlides" data-per="1"></div>
      <button class="navbtn next" aria-label="Next"><span class="material-symbols-outlined">chevron_right</span></button>
    </div>
  </section>

  <!-- Footer ad -->
  <div class="panel adbox" style="padding:6px;margin-top:10px">
    <div class="ad-inner" style="max-width:100%">
      <ins class="adsbygoogle"
           style="display:block"
           data-ad-format="fluid"
           data-ad-layout-key="+1v+s2-4-5g+9z"
           data-ad-client="ca-pub-1237323355260727"
           data-ad-slot="3319371201" data-full-width-responsive="true"></ins>
      <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
    </div>
  </div>

  <footer class="wrap">
    <div class="divider"></div>
    <div class="small">Â© 2025 SKINLABSÂ® â€” Curated skincare for South Africa. Not medical advice.</div>

    <!-- App store badges (placeholders, equal size) -->
    <div class="store-badges">
      <a href="#" aria-label="Get it on Google Play"><img src="/assets/google-play-badge-placeholder.svg" alt="Get it on Google Play"></a>
      <a href="#" aria-label="Download on the App Store"><img src="/assets/app-store-badge-placeholder.svg" alt="Download on the App Store"></a>
    </div>

    <div class="socials small">
      <a href="https://facebook.com/skinlabs.co.za" target="_blank" rel="noopener"><span class="material-symbols-outlined">public</span> Facebook</a>
      <a href="https://instagram.com/skinlabsza" target="_blank" rel="noopener"><span class="material-symbols-outlined">group</span> Instagram</a>
      <a href="https://wa.me/+27680200749" target="_blank" rel="noopener"><span class="material-symbols-outlined">chat</span> WhatsApp</a>
      <a href="https://tiktok.com/@skinlabsza" target="_blank" rel="noopener"><span class="material-symbols-outlined">play_circle</span> TikTok</a>
    </div>
  </footer>
</main>

<!-- Onboarding Modal -->
<div class="modal" id="onboardModal" role="dialog" aria-modal="true" aria-labelledby="onboardTitle">
  <div class="inner">
    <div class="ob-hero">
      <img src="/assets/onboarding-placeholder.svg" alt="Skincare illustration" />
      <div>
        <div class="small muted">Join SKINLABSÂ® â€” R99/year</div>
        <strong id="onboardTitle">Personalise your routine</strong>
      </div>
    </div>
    <div id="obProgress"><div id="obProgBar"></div></div>
    <div id="obStepsRow" class="small muted">
      <span>Account</span><span>Skin basics</span><span>Preferences</span><span>Review</span>
    </div>
    <div id="onboardSteps">
      <!-- Step 1 -->
      <div class="step" data-step="1">
        <p class="small muted">Create your account to save your profile and access features.</p>
        <label class="small">Email</label>
        <input id="obEmail" type="email" class="input" placeholder="you@example.com" required/>
        <label class="small" style="margin-top:8px">Password</label>
        <input id="obPwd" type="password" class="input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required/>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
          <button class="cta" data-next>Next</button>
        </div>
      </div>

      <!-- Step 2 -->
      <div class="step hidden" data-step="2">
        <p class="small muted">Tell us about your skin so we can personalise your routine.</p>
        <label class="small">Skin type</label>
        <select id="obSkinType" class="input">
          <option>Normal</option><option>Dry</option><option>Oily</option><option>Combination</option><option>Sensitive</option>
        </select>
        <label class="small" style="margin-top:8px">Primary concerns</label>
        <div style="display:flex;flex-wrap:wrap;gap:8px">
          <label class="chip"><input type="checkbox" value="Acne" /> Acne</label>
          <label class="chip"><input type="checkbox" value="PIH" /> Pigmentation (PIH)</label>
          <label class="chip"><input type="checkbox" value="Sensitivity" /> Sensitivity</label>
          <label class="chip"><input type="checkbox" value="Dryness" /> Dryness</label>
          <label class="chip"><input type="checkbox" value="Pores" /> Pores/Texture</label>
        </div>
        <label class="small" style="margin-top:8px">Fitzpatrick scale</label>
        <select id="obFitz" class="input">
          <option>I</option><option>II</option><option>III</option><option>IV</option><option>V</option><option>VI</option>
        </select>
        <div style="display:flex;gap:8px;justify-content:space-between;margin-top:10px">
          <button class="cta" data-prev>Back</button>
          <button class="cta" data-next>Next</button>
        </div>
      </div>

      <!-- Step 3 -->
      <div class="step hidden" data-step="3">
        <p class="small muted">A few preferences to fine-tune recommendations.</p>
        <label class="small">Monthly budget (R)</label>
        <input id="obBudget" type="number" class="input" min="0" step="10" placeholder="500" />
        <label class="small" style="margin-top:8px">Routine style</label>
        <select id="obRoutine" class="input">
          <option>Minimal (2â€“3 steps)</option><option>Balanced (4â€“5)</option><option>Maximal (6+)</option>
        </select>
        <div style="display:flex;gap:8px;justify-content:space-between;margin-top:10px">
          <button class="cta" data-prev>Back</button>
          <button class="cta" data-next>Next</button>
        </div>
      </div>

      <!-- Step 4 -->
      <div class="step hidden" data-step="4">
        <p class="small muted">Almost there. Continue to secure PayFast checkout.</p>
        <ul class="small" id="obSummary"></ul>
        <div style="display:flex;gap:8px;justify-content:space-between;margin-top:10px;flex-wrap:wrap">
          <button class="cta" data-prev>Back</button>
          <button id="obGoPay" class="btn">Continue to PayFast (R99)</button>
        </div>
        <p class="small muted" style="margin-top:8px">Youâ€™ll be redirected back here after payment is verified.</p>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button class="cta" id="obCancel"><span class="material-symbols-outlined">close</span> Cancel</button>
    </div>
  </div>
</div>

<!-- Login Modal -->
<div class="modal" id="loginModal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
  <div class="inner">
    <h3 id="loginTitle" style="margin:0 0 6px">Sign in</h3>
    <label class="small">Email</label>
    <input id="liEmail" type="email" class="input" placeholder="you@example.com" required/>
    <label class="small" style="margin-top:8px">Password</label>
    <input id="liPwd" type="password" class="input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required/>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button class="cta" id="liCancel"><span class="material-symbols-outlined">close</span> Cancel</button>
      <button class="btn" id="liGo"><span class="material-symbols-outlined">login</span> Sign in</button>
    </div>
  </div>
</div>

<!-- Thank You Modal -->
<div class="modal" id="thanksModal" role="dialog" aria-modal="true" aria-labelledby="thanksTitle">
  <div class="inner">
    <h3 id="thanksTitle" style="margin:0 0 6px">Youâ€™re in ðŸŽ‰</h3>
    <p>Access granted. You now have full access to guides, reviews, favourites and SKINLABS AI.</p>
    <div style="display:flex;justify-content:flex-end"><button class="cta" id="thanksClose">Close</button></div>
  </div>
</div>

<!-- Review Modal -->
<div class="modal" id="reviewModal" role="dialog" aria-modal="true" aria-labelledby="revTitle">
  <div class="inner">
    <h3 id="revTitle" style="margin:0 0 6px">Write a review</h3>
    <form id="reviewForm">
      <label class="small">Product/Guide</label>
      <input name="title" required placeholder="e.g., Vitamin C Guide" class="input" style="width:100%"/>
      <div style="display:flex;gap:10px;margin-top:8px;flex-wrap:wrap">
        <div style="flex:1;min-width:150px">
          <label class="small">Rating (1â€“5)</label>
          <input name="rating" type="number" min="1" max="5" required class="input" style="width:100%"/>
        </div>
        <div style="flex:1;min-width:150px">
          <label class="small">Skin type</label>
          <select name="skin" class="input" style="width:100%">
            <option>Normal</option><option>Dry</option><option>Oily</option><option>Combination</option><option>Sensitive</option>
          </select>
        </div>
      </div>
      <label class="small" style="margin-top:8px;display:block">Your review</label>
      <textarea name="body" required rows="4" class="input" style="width:100%"></textarea>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px">
        <button type="button" id="revCancel" class="cta"><span class="material-symbols-outlined">close</span> Cancel</button>
        <button type="submit" class="cta" style="background:var(--brand);color:#07332b"><span class="material-symbols-outlined">save</span> Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Floating AI Chat (available to all signed-in users) -->
<button id="fabChat" aria-label="Open AI chat"><span class="material-symbols-outlined">smart_toy</span></button>
<div id="chatPanel">
  <div class="inner">
    <div class="chat-head">
      <strong>SKINLABS AI (Derm-informed)</strong>
      <button id="chatClose" class="hamburger" style="padding:6px 8px"><span class="material-symbols-outlined">close</span></button>
    </div>
    <div class="chat-body" id="chatBody">
      <div class="msg ai"><b>Hi!</b> Ask me anything skincare. Iâ€™ll suggest evidence-based options (not medical advice).</div>
    </div>
    <div class="chat-foot">
      <input id="chatInput" class="input" placeholder="Ask about acne, pigmentation, SPFâ€¦" />
      <button id="chatSend" class="btn"><span class="material-symbols-outlined">send</span></button>
    </div>
  </div>
</div>

<script>
/* ---------------- Config ---------------- */
const API_BASE = "https://api.skinlabs.co.za";
const PRICE_ZAR = 99;

/* -------------- Theme Toggle -------------- */
const themeBtn = document.getElementById('themeToggle');
const savedTheme = localStorage.getItem('sklabs_theme');
if(savedTheme) document.documentElement.setAttribute('data-theme', savedTheme);
themeBtn.onclick = ()=>{
  const cur = document.documentElement.getAttribute('data-theme')||'dark';
  const next = cur==='dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('sklabs_theme', next);
  themeBtn.innerHTML = `<span class="material-symbols-outlined">${next==='dark'?'dark_mode':'light_mode'}</span>`;
};
themeBtn.dispatchEvent(new Event('click')); themeBtn.dispatchEvent(new Event('click'));

/* -------------- Nav -------------- */
document.getElementById('navToggle')?.addEventListener('click', ()=> document.getElementById('drawer').classList.toggle('open'));

/* -------------- Auth state & gating -------------- */
let MEMBER = false;     // paid membership
let SIGNED = false;     // any signed-in user

function setSignedInUI(isActive, isSigned){
  MEMBER = !!isActive;
  SIGNED = !!isSigned || !!isActive; // signed if backend says so OR active
  // Only hide gate copy if member; but content remains visible regardless
  document.querySelectorAll('.js-locked-copy').forEach(el=> el.classList.toggle('hidden', MEMBER));
  // Sign-up / sign-in buttons visibility
  document.querySelectorAll('.js-signup').forEach(el=> el.classList.toggle('hidden', MEMBER));
  document.querySelectorAll('.js-signin').forEach(el=> el.classList.toggle('hidden', SIGNED));
}
async function fetchSession(){
  try{
    const r = await fetch(`${API_BASE}/session`, {credentials:'include'});
    const j = await r.json();
    // heuristics: consider user is signed if any user object/flag present
    const isSigned = !!(j.user || j.loggedIn || j.signed || j.active);
    setSignedInUI(j.active === true, isSigned);
    return isSigned;
  }catch(e){ setSignedInUI(false, false); return false; }
}

/* -------------- JSON content -------------- */
const CATEGORIES = ["Guides","Ingredients","Routines","Reviews","Deals","Dermatologist Q&A","Local Brands"];
let CONTENT=[], OFFERS=[], q="", active="All";

/* -------------- Modals -------------- */
function openModal(id){ document.getElementById(id).style.display='grid'; }
function closeModal(id){ document.getElementById(id).style.display='none'; }
document.body.addEventListener('click', (e)=>{
  if(e.target.classList.contains('js-signup')){ e.preventDefault(); openModal('onboardModal'); }
  if(e.target.classList.contains('js-signin')){ e.preventDefault(); openModal('loginModal'); }
});
['onboardModal','loginModal','reviewModal','thanksModal'].forEach(id=>{
  document.getElementById(id).addEventListener('click', (e)=>{ if(e.target.id===id) closeModal(id); });
});

/* -------------- Onboarding (multi-step) -------------- */
const steps = [...document.querySelectorAll('#onboardSteps .step')];
let stepIdx = 0;
function updateProgress(){
  const pct = ((stepIdx+1)/steps.length)*100;
  document.getElementById('obProgBar').style.width = pct + '%';
}
function showStep(i){
  steps.forEach((s,k)=> s.classList.toggle('hidden', k!==i));
  stepIdx=i; updateProgress();
}
document.querySelectorAll('[data-next]').forEach(b=> b.onclick=()=> showStep(Math.min(stepIdx+1, steps.length-1)));
document.querySelectorAll('[data-prev]').forEach(b=> b.onclick=()=> showStep(Math.max(stepIdx-1, 0)));
document.getElementById('obCancel').onclick = ()=> closeModal('onboardModal');

function gatherOnboard(){
  const email = document.getElementById('obEmail').value.trim();
  const pwd = document.getElementById('obPwd').value.trim();
  const skinType = document.getElementById('obSkinType').value;
  const fitz = document.getElementById('obFitz').value;
  const budget = Number(document.getElementById('obBudget').value||0);
  const routine = document.getElementById('obRoutine').value;
  const concerns = [...document.querySelectorAll('[data-step="2"] input[type=checkbox]:checked')].map(i=>i.value);
  return { email, password: pwd, profile:{ skinType, concerns, fitz, budget, routine } };
}
document.querySelector('[data-step="4"]').addEventListener('show', ()=>{
  const d = gatherOnboard();
  const ul = document.getElementById('obSummary');
  ul.innerHTML = `
    <li>Email: ${d.email}</li>
    <li>Skin type: ${d.profile.skinType}</li>
    <li>Concerns: ${d.profile.concerns.join(', ')||'â€”'}</li>
    <li>Fitzpatrick: ${d.profile.fitz}</li>
    <li>Budget: R${d.profile.budget||0}</li>
    <li>Routine: ${d.profile.routine}</li>`;
});
function emitStepShow(){ steps[stepIdx].dispatchEvent(new Event('show')); }
['data-next','data-prev'].forEach(sel=> document.querySelectorAll(`[${sel}]`).forEach(b=> b.addEventListener('click', ()=> setTimeout(emitStepShow, 0))));
updateProgress();

/* -------------- Register + PayFast redirect -------------- */
document.getElementById('obGoPay').onclick = async ()=>{
  const data = gatherOnboard();
  if(!data.email || !data.password){ alert('Please enter email & password'); return; }
  try{
    await fetch(`${API_BASE}/auth/register`, {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(data)});
    const r = await fetch(`${API_BASE}/payfast/sign`, {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ email: data.email, amount: PRICE_ZAR, item_name: "SKINLABS Annual Membership" })});
    const j = await r.json();
    const f = document.createElement('form'); f.action = j.action; f.method='POST';
    for(const [k,v] of Object.entries(j.fields)){ const i=document.createElement('input'); i.type='hidden'; i.name=k; i.value=v; f.appendChild(i); }
    document.body.appendChild(f); f.submit();
  }catch(e){ console.error(e); alert('Could not start checkout. Please try again.'); }
};

/* -------------- Login -------------- */
document.getElementById('liCancel').onclick = ()=> closeModal('loginModal');
document.getElementById('liGo').onclick = async ()=>{
  const email = document.getElementById('liEmail').value.trim();
  const password = document.getElementById('liPwd').value.trim();
  try{
    const r = await fetch(`${API_BASE}/auth/login`, {method:'POST', headers:{'content-type':'application/json'}, credentials:'include', body: JSON.stringify({ email, password })});
    const j = await r.json();
    if(j.ok || j.active || j.user){ closeModal('loginModal'); await fetchSession(); renderAll(); } else { alert(j.error||'Login failed'); }
  }catch(e){ alert('Login error'); }
};

/* -------------- Return (thank you + claim cookie) -------------- */
async function handleReturn(){
  const u = new URL(location.href);
  const m = u.searchParams.get('m');        // m_payment_id
  const ty = u.searchParams.get('thankyou'); // set by Worker redirect or PayFast return_url
  if(m){
    const start=Date.now();
    while(Date.now()-start < 60000){
      try{
        const r = await fetch(`${API_BASE}/payfast/claim?m=${encodeURIComponent(m)}`, {credentials:'include'});
        const j = await r.json();
        if(j.activated){ break; }
      }catch(e){}
      await new Promise(res=> setTimeout(res, 2500));
    }
  }
  if(ty==='1'){ openModal('thanksModal'); document.getElementById('thanksClose').onclick = ()=> closeModal('thanksModal'); }
  if(m || ty){ history.replaceState({}, "", location.pathname); }
}

/* -------------- Search & chips -------------- */
const chipWrap = document.getElementById('chips'); const activeEl = document.getElementById('activeFilter');
function makeChip(label){ const b=document.createElement('button'); b.className='chip'; b.textContent=label; b.onclick=()=>{ active=label; activeEl.textContent=active; renderAll(); }; return b; }
function renderChips(){ chipWrap.innerHTML=''; chipWrap.appendChild(makeChip('All')); CATEGORIES.forEach(c=> chipWrap.appendChild(makeChip(c))); }
document.getElementById('btnSearch')?.addEventListener('click', ()=>{ q = document.getElementById('q').value||''; renderAll(); });
document.getElementById('q')?.addEventListener('keydown', e=>{ if(e.key==='Enter'){ q = e.target.value||''; renderAll(); }});

/* -------------- Slider util (robust swipe + autoplay everywhere) -------------- */
const SLIDERS = new WeakMap();
function slider(root, opts={per:[1,2,3], breakpoints:[0,600,900], autoplayMs:4500, pauseOnHover:true, pauseOnTouch:true}){
  if(!root) return null;
  if(SLIDERS.has(root)) return SLIDERS.get(root);

  const slidesEl = root.querySelector('.slides'), prev = root.querySelector('.prev'), next = root.querySelector('.next');
  let page=0, pages=1, timer=null, startX=0, startY=0, curX=0, dragging=false, width=1, threshold=0.18, paused=false;

  function curPer(){
    const w = root.clientWidth || window.innerWidth; let p = opts.per[0];
    if(w>=opts.breakpoints[1]) p = opts.per[1]||p; if(w>=opts.breakpoints[2]) p = opts.per[2]||p;
    slidesEl.dataset.per = String(p); return p;
  }
  function recalc(){
    const p = curPer(); const n = slidesEl.children.length; pages = Math.max(1, Math.ceil(n/p));
    page = Math.min(page, pages-1); go(page, true); width = root.clientWidth || slidesEl.clientWidth || 1;
  }
  function go(n, instant){
    page = Math.max(0, Math.min(n, pages-1));
    const x = page*100; slidesEl.style.transition = instant ? 'none' : 'transform .35s ease';
    slidesEl.style.transform = `translateX(-${x}%)`;
  }
  function auto(){ if(!opts.autoplayMs || paused) return; stop(); timer = setInterval(()=> go((page+1)%pages), opts.autoplayMs); }
  function stop(){ if(timer){ clearInterval(timer); timer=null; } }

  function onStart(x, y){ dragging = true; startX = curX = x; startY = y; slidesEl.style.transition='none'; if(opts.pauseOnTouch){ paused = true; stop(); } }
  function onMove(x, y, e){
    if(!dragging) return;
    curX = x; const dx = curX - startX; const dy = (y - startY);
    if(Math.abs(dx) > Math.abs(dy) + 6){ e && e.preventDefault(); }
    const pcent = (dx / width) * 100;
    slidesEl.style.transform = `translateX(calc(-${page*100}% + ${pcent}%))`;
  }
  function onEnd(){
    if(!dragging) return; dragging=false;
    const dx = curX - startX; const thr = width * threshold;
    if(Math.abs(dx) > thr){ go(page + (dx < 0 ? 1 : -1)); } else { go(page); }
    requestAnimationFrame(()=> slidesEl.style.transition = 'transform .35s ease');
    paused = false; auto();
  }

  // Pointer + Touch
  slidesEl.addEventListener('pointerdown', e=>{ slidesEl.setPointerCapture?.(e.pointerId); onStart(e.clientX, e.clientY); }, {passive:true});
  slidesEl.addEventListener('pointermove', e=> onMove(e.clientX, e.clientY, e), {passive:false});
  slidesEl.addEventListener('pointerup',   ()=> onEnd(), {passive:true});
  slidesEl.addEventListener('pointercancel',()=> onEnd(), {passive:true});
  slidesEl.addEventListener('touchstart', e=>{ const t=e.touches[0]; onStart(t.clientX, t.clientY); }, {passive:true});
  slidesEl.addEventListener('touchmove',  e=>{ const t=e.touches[0]; onMove(t.clientX, t.clientY, e); }, {passive:false});
  slidesEl.addEventListener('touchend',   ()=> onEnd(), {passive:true});

  prev?.addEventListener('click', ()=> go(page-1));
  next?.addEventListener('click', ()=> go(page+1));

  if(opts.pauseOnHover){ root.addEventListener('mouseenter', stop); root.addEventListener('mouseleave', auto); }
  window.addEventListener('resize', recalc, {passive:true});

  // Pause autoplay when offscreen
  const io = new IntersectionObserver((entries)=>{
    entries.forEach(en=>{ paused = !en.isIntersecting; if(paused) stop(); else auto(); });
  }, {threshold:0.1});
  io.observe(root);

  recalc(); auto();

  const api = { recalc, go, stop, auto };
  SLIDERS.set(root, api);
  return api;
}

/* -------------- Renderers -------------- */
let cardsSliderAPI, offersSliderAPI, topSliderAPI, storiesSliderAPI, catsSliderAPI, featSliderAPI;

function cardHTML(item){
  const link = item.url || '#';
  return `<div class="card">
    <div class="meta">${item.type}${item.featured ? ' â€¢ <span class="chip">Featured</span>':''}</div>
    <h3>${item.title}</h3>
    <div class="rating">â˜… ${Number(item.rating||0).toFixed(1)}</div>
    <div class="tags">${(item.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('')}</div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
      <button class="cta small btnSave ${SIGNED?'':'js-signin'}"><span class="material-symbols-outlined">grade</span> Save</button>
      <a class="small content-link" href="${link}" data-url="${link}" target="_blank" rel="noopener">Read â†’</a>
    </div></div>`;
}
function offerHTML(o){
  const link = o.url || '#';
  return `<div class="card">
    <div class="meta">${o.tag || 'Offer'}</div>
    <h3 style="margin:4px 0">${o.brand||''}</h3>
    <div class="muted">${o.title||''}</div>
    <div class="divider"></div>
    <div class="small"><b>Code:</b> ${o.code || 'N/A'}</div>
    <div class="small muted">${o.blurb||''}</div>
    <div style="margin-top:10px"><a class="cta offer-link" href="${link}" data-url="${link}" target="_blank" rel="noopener"><span class="material-symbols-outlined">shopping_bag</span> Shop now</a></div>
  </div>`;
}
function featHTML(a){
  const link = a.url;
  return `<div class="card" style="overflow:hidden">
    <img src="${a.img}" alt="${a.alt}" style="border-radius:10px"/>
    <div class="meta" style="margin-top:6px">Evergreen</div>
    <h3>${a.title}</h3>
    <p class="small muted">${a.excerpt}</p>
    <div><a class="cta content-link" href="${link}" data-url="${link}" target="_blank" rel="noopener"><span class="material-symbols-outlined">open_in_new</span> Read on Medium</a></div>
  </div>`;
}
function buildCountdownSlide(){
  const target = new Date('2025-09-01T00:00:00+02:00');
  const id = 'countdown';
  const wrap = document.createElement('div');
  wrap.className='slide';
  wrap.innerHTML = `<div class="card" style="text-align:center">
    <div class="meta">Announcement</div>
    <h3>Relaunch Countdown</h3>
    <div class="small muted">Official launch: <b>1 Sep 2025</b></div>
    <div id="${id}" style="font-weight:800;font-size:clamp(18px,6vw,28px);margin:8px 0">--:--:--</div>
    <p class="small muted">Sign up now for early access and giveaways!</p>
    <button class="btn js-signup"><span class="material-symbols-outlined">event</span> Join early access</button>
  </div>`;
  function tick(){
    const now = new Date();
    const diff = target - now;
    const el = document.getElementById(id);
    if(!el) return;
    if(diff<=0){ el.textContent = '00:00:00'; return; }
    const d = Math.floor(diff/86400000);
    const h = Math.floor((diff%86400000)/3600000);
    const m = Math.floor((diff%3600000)/60000);
    const s = Math.floor((diff%60000)/1000);
    el.textContent = `${d}d ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }
  setInterval(tick,1000); tick();
  return wrap;
}

/* Featured Collections data */
const FEATURED_CATS = [
  {title:"â­ Staff Picks: Product of the Month", blurb:"Curated skincare heroes with expert selections"},
  {title:"ðŸ§´ DIY Skincare Recipe Series", blurb:"Step-by-step honey oat mask tutorial"},
  {title:"ðŸ”¬ Brand Spotlight", blurb:"Deep dives into innovative skincare brands"},
  {title:"âŒ Skincare Myths Debunked", blurb:"Science-backed myth-busting content"},
  {title:"ðŸ‚ Seasonal Transition Guide", blurb:"Summer to fall skincare adaptation"},
  {title:"ðŸŽ¯ Skin Concern Solutions", blurb:"30-day acne treatment plans"},
  {title:"ðŸ§ª Ingredient Deep Dive", blurb:"Complete retinol usage guide"},
  {title:"â° Lifestyle Routines", blurb:"3-step routines for busy professionals"},
  {title:"âœ¨ Community Transformations", blurb:"Real member success stories"},
  {title:"ðŸŽ™ï¸ Whatâ€™s In It For Me?", blurb:"[Gemini AI Notebook LM Audio Summaries]"},
  {title:"ðŸŽ Members-Only Rewards", blurb:"Sponsored giveaways & competitions"},
];

/* Stories sample data */
const STORIES = [
  {title:"SPF Re-Apply Hacks", cover:"https://images.unsplash.com/photo-1505575967455-40e256f73376?q=80&w=800&auto=format&fit=crop"},
  {title:"Winter â†’ Spring Routine", cover:"https://images.unsplash.com/photo-1512499617640-c2f999098c80?q=80&w=800&auto=format&fit=crop"},
  {title:"Retinol Ramp-Up", cover:"https://images.unsplash.com/photo-1585238342028-4bbc91a30fa9?q=80&w=800&auto=format&fit=crop"},
  {title:"PIH Care Basics", cover:"https://images.unsplash.com/photo-1606836591695-4d58a73eba1e?q=80&w=800&auto=format&fit=crop"},
  {title:"Mineral vs Hybrid SPF", cover:"https://images.unsplash.com/photo-1512499617640-c2f999098c80?q=80&w=800&auto=format&fit=crop"}
];

/* Featured (Medium) */
const FEATURED = [
  {title:"Derm-Backed Sunscreen Guide for Every Skin Tone", excerpt:"SPF filters, PA ratings and re-application tips tailored to South African sun.", img:"https://images.unsplash.com/photo-1505575967455-40e256f73376?q=80&w=1600&auto=format&fit=crop", alt:"Sunscreen on skin", url:"https://blog.skinlabs.africa/sunscreen-for-every-skin-tone"},
  {title:"Retinoids 101: Start Without Irritation", excerpt:"A gentle ramp-up plan and what to combine (or avoid) in your night routine.", img:"https://images.unsplash.com/photo-1585238342028-4bbc91a30fa9?q=80&w=1600&auto=format&fit=crop", alt:"Retinoid bottle", url:"https://blog.skinlabs.africa/retinoids-101-south-africa"},
  {title:"Hyperpigmentation in SA: What Actually Works", excerpt:"Evidence-based actives â€” azelaic acid, niacinamide, arbutin â€” and how to layer.", img:"https://images.unsplash.com/photo-1606836591695-4d58a73eba1e?q=80&w=1600&auto=format&fit=crop", alt:"Skincare routine", url:"https://blog.skinlabs.africa/hyperpigmentation-south-africa-guide"},
  {title:"Hydration Myths â€” and Products that Truly Help", excerpt:"Humectants vs emollients vs occlusives, simplified.", img:"https://images.unsplash.com/photo-1532712938310-34cb3982ef74?q=80&w=1600&auto=format&fit=crop", alt:"Water drop on leaf", url:"https://blog.skinlabs.africa/hydration-myths-products"},
  {title:"Morning Routine Builder: 3 Price Tiers", excerpt:"Budget, mid-range and premium picks you can buy locally.", img:"https://images.unsplash.com/photo-1512499617640-c2f999098c80?q=80&w=1600&auto=format&fit=crop", alt:"Bathroom counter", url:"https://blog.skinlabs.africa/morning-routine-builder-tiers"},
  {title:"Sensitive Skin? A Fragrance-Smart Routine", excerpt:"Reduce flare-ups with simple swaps and smarter patch testing.", img:"https://images.unsplash.com/photo-1585238341951-452dc6e0f3a9?q=80&w=1600&auto=format&fit=crop", alt:"Serum dropper", url:"https://blog.skinlabs.africa/sensitive-skin-fragrance-smart"},
  {title:"SPF on a Budget in SA", excerpt:"Tinted hybrids and drugstore mineral options that donâ€™t break the bank.", img:"https://images.unsplash.com/photo-1556228453-efd1a6ea0474?q=80&w=1600&auto=format&fit=crop", alt:"Budget SPF", url:"https://blog.skinlabs.africa/budget-spf-south-africa"},
  {title:"Niacinamide: Friend or Foe?", excerpt:"When it shines, when it pills, and how to dose for your skin type.", img:"https://images.unsplash.com/photo-1601050690597-9d5c2c22d2b4?q=80&w=1600&auto=format&fit=crop", alt:"Serum bottle", url:"https://blog.skinlabs.africa/niacinamide-guide"},
  {title:"Adapalene Starter Plan", excerpt:"A 6-week blueprint to minimise purge and maximise results.", img:"https://images.unsplash.com/photo-1546435770-a3e426bf472b?q=80&w=1600&auto=format&fit=crop", alt:"Skincare routine layout", url:"https://blog.skinlabs.africa/adapalene-starter"},
  {title:"Barrier Repair Essentials", excerpt:"Ceramides, cholesterol, fatty acids â€” and how to layer them.", img:"https://images.unsplash.com/photo-1522335789203-aabd1fc54bc9?q=80&w=1600&auto=format&fit=crop", alt:"Cream texture", url:"https://blog.skinlabs.africa/barrier-repair"}
];

/* SEO ItemList helper */
function injectItemListSchema(items){
  try{
    const ld = {"@context":"https://schema.org","@type":"ItemList","itemListElement":items.slice(0,10).map((it,idx)=>({"@type":"ListItem","position":idx+1,"name":it.title,"url":it.url || "https://skinlabs.co.za/"}))};
    const s=document.createElement('script'); s.type="application/ld+json"; s.textContent=JSON.stringify(ld); document.head.appendChild(s);
  }catch(e){}
}

/* Render all sections */
function renderAll(){
  const list = CONTENT.filter(i => (active==='All'||i.type===active) && (q===''||(i.title||'').toLowerCase().includes(q.toLowerCase())));

  // Cards
  const cardsEl = document.getElementById('cardsSlides'); cardsEl.innerHTML='';
  list.forEach(item=>{ const d=document.createElement('div'); d.className='slide'; d.innerHTML=cardHTML(item); cardsEl.appendChild(d); });
  cardsSliderAPI = slider(document.getElementById('cardsSlider'), {per:[1,2,3,4], breakpoints:[0,600,900], autoplayMs:5000});

  // Offers
  const offersEl = document.getElementById('offersSlides'); offersEl.innerHTML='';
  OFFERS.forEach(o=>{ const w=document.createElement('div'); w.className='slide'; w.innerHTML=offerHTML(o); offersEl.appendChild(w); });
  offersSliderAPI = slider(document.getElementById('offersSlider'), {per:[1,2,3], breakpoints:[0,600,900], autoplayMs:4200});

  // Trending
  const topEl = document.getElementById('topSlides'); topEl.innerHTML='';
  topEl.appendChild(buildCountdownSlide());
  [...CONTENT].sort((a,b)=>Number(b.rating||0)-Number(a.rating||0)).slice(0,8).forEach(x=>{
    const w=document.createElement('div'); w.className='slide';
    w.innerHTML=`<div class="card"><div class="meta">Trending</div><h3>${x.title}</h3><div class="rating">â˜… ${Number(x.rating||0).toFixed(1)}</div></div>`;
    topEl.appendChild(w);
  });
  topSliderAPI = slider(document.getElementById('topSlider'), {per:[1,1,2,3], breakpoints:[0,700,980], autoplayMs:3800});

  // Featured Collections
  const cats = document.getElementById('catsSlides'); cats.innerHTML='';
  FEATURED_CATS.forEach(c=>{
    const w=document.createElement('div'); w.className='slide';
    w.innerHTML = `<div class="card"><div class="meta">Collection</div><h3 style="margin:6px 0 4px">${c.title}</h3><p class="small muted" style="margin:0">${c.blurb}</p></div>`;
    cats.appendChild(w);
  });
  catsSliderAPI = slider(document.getElementById('catsSlider'), {per:[1,2,3], breakpoints:[0,700,980], autoplayMs:4600});

  // Featured (Medium)
  const slides=document.getElementById('featSlides'); slides.innerHTML='';
  FEATURED.forEach(a=>{ const w=document.createElement('div'); w.className='slide'; w.innerHTML=featHTML(a); slides.appendChild(w); });
  featSliderAPI = slider(document.getElementById('featSlider'), {per:[1,2,3], breakpoints:[0,700,980], autoplayMs:4400});

  // Stories
  const sWrap = document.getElementById('storiesSlides'); sWrap.innerHTML='';
  STORIES.forEach(s=>{
    const d=document.createElement('div'); d.className='slide';
    d.innerHTML = `<div class="card story-card" style="overflow:hidden">
      <img src="${s.cover}" alt="${s.title}" style="width:100%;height:180px;object-fit:cover;border-radius:10px"/>
      <div class="meta" style="margin-top:6px">Story</div>
      <h3>${s.title}</h3>
    </div>`;
    sWrap.appendChild(d);
  });
  storiesSliderAPI = slider(document.getElementById('storiesSlider'), {per:[2,3,5], breakpoints:[0,600,980], autoplayMs:4000});

  renderCommunity();
  injectItemListSchema(list);
}

/* -------------- Data -------------- */
async function loadJSON(path){ const r=await fetch(path,{cache:'no-store'}); if(!r.ok) throw 0; return r.json(); }
async function initData(){
  try{
    [CONTENT, OFFERS] = await Promise.all([loadJSON('./data/content.json'), loadJSON('./data/offers.json')]);
  }catch(e){
    CONTENT = [
      {"type":"Guides","title":"Vitamin C: How to layer with Niacinamide","rating":4.8,"tags":["Brightening","Beginner"],"featured":true},
      {"type":"Ingredients","title":"Retinoids in SA: OTC vs Rx","rating":4.6,"tags":["Anti-ageing","Night"],"featured":true},
      {"type":"Routines","title":"Winter-to-Spring Routine (Budget)","rating":4.5,"tags":["Seasonal","Budget"],"featured":false},
      {"type":"Deals","title":"5 SA dupes for the viral HA serum","rating":4.0,"tags":["Dupe","Hydration"],"featured":false},
      {"type":"Local Brands","title":"SA mineral sunscreens roundup","rating":4.3,"tags":["Sunscreen","Local"],"featured":false},
      {"type":"Dermatologist Q&A","title":"Ask a Derm: Tretinoin vs Adapalene","rating":4.7,"tags":["Acne","Rx"],"featured":true},
      {"type":"Guides","title":"Niacinamide vs Tranexamic Acid","rating":4.5,"tags":["Pigmentation","AM"],"featured":false},
      {"type":"Routines","title":"3-step Busy Professional AM/PM","rating":4.4,"tags":["Lifestyle","Time-saving"],"featured":false}
    ];
    OFFERS = [
      {"brand":"Clicks","title":"3-for-2 Skincare","code":"","url":"#","blurb":"ClubCard deals.","tag":"Pharmacy"},
      {"brand":"Dis-Chem","title":"R100 OFF â‰¥ R600","code":"DERMA100","url":"#","blurb":"Derma shop promo.","tag":"Pharmacy"}
    ];
  }
}

/* -------------- Community Forum (seed + features) -------------- */
function seedForum(){
  const has = JSON.parse(localStorage.getItem('sklabs_forum_posts')||'[]');
  if(has.length) return has;
  const now = Date.now();
  const posts = [
    {title:"Sunscreen for darker tones (mineral vs hybrid)", product:"Heliocare 360", rating:5, skin:"Combination", verified:true, user:"Lerato P.", city:"Johannesburg", body:"No white cast with the gel oil-free. Reapplies well.", helpful:23, comments:5, views:612, ts: now-36*3600e3},
    {title:"Azelaic acid for PIH", product:"The Ordinary Azelaic 10%", rating:4, skin:"Oily", verified:false, user:"Thabo K.", city:"Pretoria", body:"Took ~6 weeks. Pairing with niacinamide helped.", helpful:15, comments:3, views:421, ts: now-72*3600e3},
    {title:"Budget moisturiser recs", product:"E45 / Nivea Soft", rating:4, skin:"Dry", verified:true, user:"Zanele M.", city:"Durban", body:"Layer with HA serumâ€”great for winter.", helpful:12, comments:2, views:377, ts: now-9*3600e3},
    {title:"30-day acne plan results", product:"Adapalene 0.1%", rating:5, skin:"Oily", verified:true, user:"Farai N.", city:"Cape Town", body:"Purge week 2â€“3, then clearer texture.", helpful:28, comments:7, views:818, ts: now-5*24*3600e3},
    {title:"Retinol sandwich method", product:"Cerave PM + Retinol 0.3%", rating:4, skin:"Sensitive", verified:false, user:"Naledi S.", city:"Bloemfontein", body:"Less irritation, slower results but worth it.", helpful:9, comments:1, views:233, ts: now-14*3600e3},
    {title:"Hybrid SPF dupes in SA", product:"Clicks Sun Protect", rating:3, skin:"Normal", verified:false, user:"Anika V.", city:"Gqeberha", body:"Finish is dewy; wish it was less fragranced.", helpful:6, comments:0, views:190, ts: now-11*24*3600e3},
    {title:"Fragrance-free cleanser finds", product:"SVR Sensifine", rating:5, skin:"Sensitive", verified:true, user:"Aisha B.", city:"Polokwane", body:"Soothing; doesnâ€™t strip. Great value online.", helpful:19, comments:3, views:402, ts: now-2*24*3600e3},
    {title:"Vitamin C + Niacinamide layering", product:"SkinCeuticals CE Ferulic", rating:5, skin:"Combination", verified:true, user:"Sipho D.", city:"Midrand", body:"AM: Vit C â†’ wait â†’ Niacinamide â†’ SPF. Glow!", helpful:31, comments:9, views:1021, ts: now-20*3600e3},
    {title:"Maskne tips post-gym", product:"La Roche-Posay Cicaplast B5", rating:4, skin:"Normal", verified:false, user:"Gugu R.", city:"Pietermaritzburg", body:"Rinse ASAP, use light gel moisturiser + SPF.", helpful:8, comments:1, views:240, ts: now-3*24*3600e3},
    {title:"Mineral SPF for kids", product:"Pure Beginnings Baby SPF", rating:5, skin:"Dry", verified:true, user:"Mpho T.", city:"Soweto", body:"No stinging, easy to remove.", helpful:17, comments:4, views:350, ts: now-7*24*3600e3}
  ];
  localStorage.setItem('sklabs_forum_posts', JSON.stringify(posts));
  return posts;
}
function timeAgo(ts){
  const s = Math.max(1, Math.floor((Date.now()-ts)/1000));
  const units = [[31536000,'y'],[2592000,'mo'],[604800,'w'],[86400,'d'],[3600,'h'],[60,'m']];
  for(const [sec,label] of units){ if(s>=sec) return Math.floor(s/sec)+label; }
  return s+'s';
}
const POLL_KEY='sklabs_poll_votes';
function getPoll(){ return JSON.parse(localStorage.getItem(POLL_KEY) || '{"Q":"Whatâ€™s your #1 skincare goal now?","opts":["Clear acne","Fade pigmentation","Reduce sensitivity","Anti-ageing"],"votes":[35,28,18,31]}'); }
function savePoll(p){ localStorage.setItem(POLL_KEY, JSON.stringify(p)); }
function renderPoll(container){
  const p = getPoll(); const total = p.votes.reduce((a,b)=>a+b,0);
  container.innerHTML = `
    <div class="poll">
      <div class="small muted" style="margin-bottom:6px">${p.Q}</div>
      ${p.opts.map((o,i)=>{
        const pct = total ? Math.round((p.votes[i]/total)*100) : 0;
        return `<div style="margin:8px 0">
          <div class="small" style="display:flex;justify-content:space-between">
            <span>${o}</span><span class="muted">${pct}%</span>
          </div>
          <div class="bar"><span style="width:${pct}%"></span></div>
          <button class="cta small" data-vote="${i}" style="margin-top:6px">Vote</button>
        </div>`;
      }).join('')}
      <div class="small muted">Total votes: ${total}</div>
    </div>`;
  container.querySelectorAll('[data-vote]').forEach(btn=>{
    btn.onclick = ()=>{
      const idx = Number(btn.getAttribute('data-vote')); const cur = getPoll();
      cur.votes[idx] += 1; savePoll(cur); renderPoll(container);
    };
  });
}
function renderCommunity(){
  const listR = seedForum();
  const wrap = document.getElementById('reviewList');
  wrap.classList.add('forum');
  wrap.innerHTML='';
  listR.slice(0,10).forEach(r=>{
    const stars = Array.from({length:5},(_,i)=> i<r.rating?'<span class="star">grade</span>':'<span class="star" style="opacity:.25">grade</span>').join('');
    const ver = r.verified ? '<span class="verified" title="Verified user">verified</span>' : '';
    const card = document.createElement('div');
    card.className='review';
    card.innerHTML = `
      <b>${r.title}</b> ${ver}
      <div class="post-meta">
        <span>By ${r.user} â€¢ ${r.city}</span>
        <span>${r.skin}</span>
        <span>${timeAgo(r.ts)} ago</span>
        <span>${r.views} views â€¢ ${r.comments} comments</span>
      </div>
      <div class="small muted">Product: <b>${r.product}</b></div>
      <div class="rating" style="margin:4px 0">${stars}</div>
      <div class="small" style="margin:6px 0">${r.body}</div>
      <button class="helpful" data-helpful><span class="material-symbols-outlined">thumb_up</span><span>Helpful</span><span class="count">${r.helpful}</span></button>
    `;
    const btn = card.querySelector('[data-helpful]');
    btn.onclick = ()=>{
      const countEl = btn.querySelector('.count');
      countEl.textContent = String(Number(countEl.textContent||0) + 1);
    };
    wrap.appendChild(card);
  });
  let pollBox = document.getElementById('forumPoll');
  if(!pollBox){
    pollBox = document.createElement('div');
    pollBox.id='forumPoll'; pollBox.style.marginTop='10px';
    wrap.parentElement.appendChild(pollBox);
  }
  renderPoll(pollBox);
}

/* -------------- Link gating: open login/signup when content clicked -------------- */
document.addEventListener('click', (e)=>{
  const a = e.target.closest('a.content-link, a.offer-link');
  if(!a) return;
  const url = a.getAttribute('data-url') || a.getAttribute('href') || '#';
  if(!SIGNED){
    e.preventDefault();
    openModal('loginModal');
    return;
  }
  // signed in â€” open link normally in a new tab
  a.setAttribute('target','_blank');
});

/* -------------- AI Chat (available to SIGNED users) -------------- */
const fab=document.getElementById('fabChat'); const chatPanel=document.getElementById('chatPanel'); const chatBody=document.getElementById('chatBody'); const chatInput=document.getElementById('chatInput');
document.getElementById('chatClose').onclick=()=> chatPanel.style.display='none';
fab.onclick=()=>{ if(!SIGNED){ openModal('loginModal'); return; } chatPanel.style.display = (chatPanel.style.display==='block'?'none':'block'); };
document.getElementById('chatSend').onclick = sendChat; chatInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); sendChat(); } });
let convo=[{role:"system",content:"You are SKINLABS AI. Provide evidence-based skincare guidance for South Africans. Not medical advice. Ask clarifying questions."}];
async function sendChat(){
  if(!SIGNED) return;
  const t=chatInput.value.trim(); if(!t) return; chatInput.value='';
  const me=document.createElement('div'); me.className='msg me'; me.textContent=t; chatBody.appendChild(me); chatBody.scrollTop=chatBody.scrollHeight;
  try{
    const r=await fetch(`${API_BASE}/ai`, {method:'POST', headers:{'content-type':'application/json'}, credentials:'include', body: JSON.stringify({ messages:[...convo,{role:'user',content:t}] })});
    const j=await r.json(); const out=j.output || 'Sorry, I could not reply.';
    const a=document.createElement('div'); a.className='msg ai'; a.innerHTML = out.replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])).replace(/\n/g,'<br/>'); chatBody.appendChild(a); chatBody.scrollTop=chatBody.scrollHeight;
  }catch(e){
    const a=document.createElement('div'); a.className='msg ai'; a.textContent='Network error. Try again.'; chatBody.appendChild(a);
  }
}

/* -------------- Boot -------------- */
(async function boot(){
  renderChips();
  await initData();
  await fetchSession();
  await handleReturn();
  renderAll();
})();
</script>
</body>
</html>
